---
title: "UKBB-MH-limbic"
author: "Simon Schwab"
date: "30 May 2018"
output: html_notebook
---

## Install required packages
```{r}
# install.packages("rmarkdown")
# install.packages("DGM")
# install.packages("cowplot")
# install.packages("ppcor")
# install.packages("abind")
# install.packages("testit")
```

## Libraries
```{r message=FALSE, warning=FALSE}
library(ggplot2)
library(DGM)
library(reshape2)
library(cowplot)
library(ppcor)
library(abind)
library(testit)
library(data.table)
```

## Variables
```{r}
INFO = 'limbic'
Nn=10
N=135
Nt=490
TR=2
PATH_HOME = '/home/simon'
PATH_PROJ = file.path(PATH_HOME, 'Data', 'UKBB-MH') # Project path
PATH_RESULTS = file.path(PATH_PROJ, 'results')
PATH_FIGS = file.path(PATH_PROJ, 'figures')
PATH_UKBB = file.path(PATH_HOME, 'Drive', 'ukbiobank')

PATH_NET = file.path(PATH_HOME, 'Drive', 'DGM_limbic')
PATH_TS = file.path(PATH_HOME, 'Drive', 'limbic')

FSLEYES = '/usr/bin/fsleyes'
ATLAS = file.path(PATH_PROJ, 'atlas')
Sys.setenv(FSLEYES=FSLEYES, ATLAS=ATLAS)

sel = 1:10; # selection of the nodes
br = Nn - 0.5 # break for figures
```

## Load subject info
```{r}
load(file = file.path(PATH_UKBB, 'UKBB-MH.RData'))
mydata=subset(subjects, subset = subjects$hasfMRI)
is.ctrl = mydata$group == 'control'
is.pati = mydata$group == 'patient'

labels = read.table(file.path(PATH_PROJ, 'atlas', 'labels_limbic.txt'))
mylabels = labels$V2[sel]
```

## FSLeyes: show nodes
```{bash eval=FALSE, include=FALSE}
source /etc/fsl/fsl.sh

# echo $ATLAS_SHIRER
export NO_AT_BRIDGE=1 # accessibility bus warning

echo $FSLEYES

$FSLEYES --standard1mm $OPTS \
   $ATLAS/limbic.nii.gz -cm hsv -a 50 \
```

## Load time series data
```{r}
f = list.files(PATH_TS, sprintf('*%s*.txt', INFO))
# read data
ts = array(NA, dim=c(Nt, Nn, N))
for (s in 1:N) {
  d = as.matrix(read.table(file.path(PATH_TS, f[s]), header = F))
  ts[,,s] = scaleTs(d[1:Nt,sel]) # some subjects have more volumes
}
```

## Plot example time series
```{r, fig.height=3, fig.width=8}
set.seed(1980)
s = sample(N, 4)
n = sample(Nn, 3)
idx=1:100

p = list()
c = 1
for (i in s) {
  d = ts[,n,i]
  colnames(d)=mylabels[n]
  d_ = melt(d[idx,])
  d_$Var2=as.factor(d_$Var2)
  p[[c]] = ggplot(d_, aes(x = Var1, y = value, group=Var2, color=Var2)) + 
    geom_line() + theme_minimal() + ggtitle(f[i])
  c = c + 1
}

plot_grid(plotlist = p, ncol = 2, nrow = 2, rel_widths = c(1, 1))
```

## Run DGM on HCP cluster

## Load DGM networks
```{r eval=FALSE, include=FALSE}
subj=list()
for (s in 1:N) {
  print(sprintf("Loading Subject %03d", s))
  subj[[s]] = read.subject(path=PATH_NET, id=sprintf("%s_%s", mydata$eid[s], INFO), Nn, modelStore = T)
  subj[[s]]$thr = pruning(adj = subj[[s]]$adj, models = subj[[s]]$models, winner = subj[[s]]$winner, e = 5)
}
dgm.ctrl=dgm.group(subj[is.ctrl])
dgm.pati=dgm.group(subj[is.pati])

save(dgm.ctrl, dgm.pati, file = file.path(PATH_RESULTS, sprintf('DGM-%s.RData', INFO)), compress = T)
```
### Load from RData
```{r}
load(file.path(PATH_RESULTS, sprintf('DGM-%s.RData', INFO)))
```

## Discount factor
```{r fig.height=2, fig.width=6}
colnames(dgm.ctrl$df_) = mylabels
colnames(dgm.pati$df_) = mylabels

set.seed(1980) # because jitter will always create a slightly different image
p1 = ggplot(melt(dgm.ctrl$df_), aes(x=as.factor(Var2), y=value)) +
  geom_point(shape=1, color="gray50", size=1, position = position_jitter(width = NULL, height = 0)) +
  geom_boxplot(width=0.6) + theme(axis.text = element_text(size=8), axis.text.x = element_text(angle=90)) +
  ggtitle(sprintf("controls", N)) + ylab("df") + xlab("node") + ylim(c(0.5, 1))

p2 = ggplot(melt(dgm.pati$df_), aes(x=as.factor(Var2), y=value)) +
  geom_point(shape=1, color="gray50", size=1, position = position_jitter(width = NULL, height = 0)) +
  geom_boxplot(width=0.6) + theme(axis.text = element_text(size=8), axis.text.x = element_text(angle=90)) +
  ggtitle(sprintf("patients", N)) + ylab("df") + xlab("node") + ylim(c(0.5, 1))

plot_grid(p1, p2, ncol = 2, nrow = 1)
```
### DF Summary stats
```{r, fig.height=5.2, fig.width=6.5}
x=rbind(summary(c(dgm.ctrl$df_)),
        summary(c(dgm.pati$df_)))
rownames(x)=c("controls", "patients")
print(x)
```
### Proportion of time-varying fits vs. stationary networks (df = 1)
```{r}
x = array(NA, dim = c(1,2))
x[1,] = c(sum(dgm.ctrl$df_ < 1) / (sum(is.ctrl)*Nn),
          sum(dgm.pati$df_ < 1) / (sum(is.pati)*Nn))
colnames(x) = c("controls", "patients")
print(x)
```

## Stats Binomial test
```{r}
stats.ctrl = binom.nettest(dgm.ctrl$tam, alter = "greater", fdr = 0.05)
stats.pati = binom.nettest(dgm.pati$tam, alter = "greater", fdr = 0.05)

am.all = abind(dgm.ctrl$tam, dgm.pati$tam, along = 3)
assert(all(dim(am.all) == c(Nn, Nn, N)))
stats.all = binom.nettest(am.all, alter = "greater", fdr = 0.05)

x1 = apply(dgm.ctrl$tam, c(1,2), sum)
x2 = apply(dgm.pati$tam, c(1,2), sum)
# x1[3,11] = x1[3,11] - (x1[3,11] - 0) # test sensitivity 

stats.prop = prop.nettest(x1 = x1,
                          n1 = sum(is.ctrl),
                          x2 = x2,
                          n2 = sum(is.pati),
                          fdr = 0.05, alpha = 0.05)
```

## Plot Network
```{r fig.height=5, fig.width=9, message=FALSE}
p1 = gplotMat(stats.ctrl$adj, title = "controls", barWidth = 0.3,
              nodeLabels = mylabels, xAngle = 90, axisTextSize = 8) +
  scale_x_continuous(breaks = 0.5:br, labels = mylabels)

p2 = gplotMat(stats.pati$adj, title = "patients", barWidth = 0.3,
              nodeLabels = mylabels, xAngle = 90, axisTextSize = 8) +
  scale_x_continuous(breaks = 0.5:br, labels = mylabels)

p3 = gplotMat(stats.ctrl$adj - stats.pati$adj, lim = c(-0.2, 0.2), 
              title = "controls-patients", barWidth = 0.3, gradient = c("blue", "white", "red"),
              nodeLabels = mylabels, xAngle = 90, axisTextSize = 8) +
  scale_x_continuous(breaks = 0.5:br, labels = mylabels)

p4 = gplotMat(stats.ctrl$adj_fdr, title = "controls (FDR)", barWidth = 0.3,
              nodeLabels = mylabels, xAngle = 90, axisTextSize = 8) +
  scale_x_continuous(breaks = 0.5:br, labels = mylabels)

p5 = gplotMat(stats.pati$adj_fdr, title = "patients (FDR)", barWidth = 0.3,
              nodeLabels = mylabels, xAngle = 90, axisTextSize = 8) +
  scale_x_continuous(breaks = 0.5:br, labels = mylabels)

p6 = gplotMat((stats.ctrl$adj - stats.pati$adj)*(stats.prop$z_uncorr != 0), title = "controls-patients (p < .05, uc.)",
              gradient = c("blue", "white", "red"), lim = c(-0.2, 0.2),
              nodeLabels = mylabels, xAngle = 90, axisTextSize = 8,  barWidth = 0.3) +
  scale_x_continuous(breaks = 0.5:br, labels = mylabels)

plot_grid(p1, p2, p3, p4, p5, p6, ncol = 3, nrow = 2, rel_widths = c(1, 1))
ggsave(path = PATH_FIGS, sprintf('DGM_%s-Proportions.png', INFO))
```

## Create group network
### Get models
```{r}
AM.all_FDR = array(0, dim=c(Nn, Nn))
# AM.all_FDR[stats.all$adj_fdr > 0] = 1
AM.all_FDR[(stats.pati$adj_fdr > 0) | (stats.ctrl$adj_fdr > 0)] = 1

# add additional nodes of interest that were significant
AM.all_FDR[stats.prop$z_uncorr != 0] = 1

groupModel.nr = rep(NA, Nn)

# get model nr
for (n in 1:Nn) {
  space = model.generator(Nn, n)
  par = which(AM.all_FDR[,n]==1)
  
  groupModel.nr[n] = getModelNr(space, par)
}
```

### Plot group networks
```{r fig.height=2.5, fig.width=5, message=FALSE}
p1 = gplotMat(stats.all$adj_fdr, title = "sign. proportions", barWidth = 0.3,
              nodeLabels = mylabels, xAngle = 90, axisTextSize = 8) +
  scale_x_continuous(breaks = 0.5:br, labels = mylabels)

p2 = gplotMat(AM.all_FDR, title = "group network", barWidth = 0.3, hasColMap = F,
              nodeLabels = mylabels, xAngle = 90, axisTextSize = 8) +
  scale_x_continuous(breaks = 0.5:br, labels = mylabels)

plot_grid(p1, p2, ncol = 2, nrow = 1, rel_widths = c(1.3, 1))
ggsave(path = PATH_FIGS, sprintf('DGM_%s-GroupNets.png', INFO))
```

## Get deltas
```{r eval=FALSE, include=FALSE}
# We get deltas for the group models only
DE=array(NA, dim=c(Nn, N))

for (n in 1:Nn) {
  print(sprintf("========= Node %03d =========", n))
  for (s in 1:N) {
    # print(sprintf("Loading Subject %03d", s))
    file=file.path(PATH_NET, sprintf("%s_%s_node_%03d.txt", mydata$eid[s], INFO, n))
    tmp=scan(file, skip = Nn+1, nlines = 1) # faster than fread
    # DE[n, s] = tmp[m.all[n]]
    DE[n, s] = tmp[groupModel.nr[n]]
  }
}

save(DE, file = file.path(PATH_RESULTS, sprintf('deltas-%s.RData', INFO)))
```

### descriptives delta
```{r}
load(file.path(PATH_RESULTS, sprintf('deltas-%s.RData', INFO)))

x = as.matrix(apply(DE < 1, 1, sum))
colnames(x) = c('no. of subjects with dynamic model')
rownames(x) = 1:Nn
print(x)
```


## Connectivity strengths
### Calculate thetas
```{r eval=FALSE, include=FALSE}
TH=list()

for (n in 1:Nn) { # nodes
  print(sprintf("Node %03d done!", n))
  pars = which(as.logical(AM.all_FDR[,n]))
  theta = array(NA, dim=c(Nt, length(pars), N))
  
  for (s in 1:N) { # subjects
    Ft=array(1, dim=c(Nt,length(pars)+1))
    Ft[,2:ncol(Ft)]=ts[,pars,s] # selects parents
    Yt=ts[,n,s]
    
    fit=dlm.lpl(Yt, t(Ft), delta = DE[n,s])
    y = dlm.retro(fit$mt, fit$CSt, fit$RSt, fit$nt, fit$dt)
    
    theta[,,s]=t(y$smt[2:(length(pars)+1),])
  }
  
  TH[[n]] = theta
}

save(TH, file = file.path(PATH_RESULTS, sprintf('thetas-%s.RData', INFO)))
```

### Create adjacency matrix with connectivity strengths 
```{r}
load(file.path(PATH_RESULTS,  sprintf('thetas-%s.RData', INFO)))

thetas.mean = array(NA, dim=c(Nn, Nn, N))
thetas.sd = array(NA, dim=c(Nn, Nn, N))

for (n in 1:Nn) {
  thetas.mean[,n,][as.logical(AM.all_FDR[,n]),] = apply(TH[[n]], c(2,3), mean)
  thetas.sd[,n,][as.logical(AM.all_FDR[,n]),] = apply(TH[[n]], c(2,3), sd)
}

thetas.mean.pati = apply(thetas.mean[,,is.pati], c(1,2), mean)
thetas.mean.ctrl = apply(thetas.mean[,,is.ctrl], c(1,2), mean)

thetas.sd.pati = apply(thetas.sd[,,is.pati], c(1,2), mean)
thetas.sd.ctrl = apply(thetas.sd[,,is.ctrl], c(1,2), mean)
```

### Analysis within dynamic relationships (removing stationary nodes)
```{r}
thetas.sd.dyn = thetas.sd
thetas.mean.dyn = thetas.mean

for (s in 1:N) {
  idx=which(DE[,s] >= 1)
  thetas.sd.dyn[,idx,s] = NA # remove non-dynamic values
  thetas.mean.dyn[,idx,s] = NA
}

thetas.mean.dyn.pati = apply(thetas.mean.dyn[,,is.pati], c(1,2), mean, na.rm=T)
thetas.mean.dyn.ctrl = apply(thetas.mean.dyn[,,is.ctrl], c(1,2), mean, na.rm=T)

thetas.sd.dyn.pati = apply(thetas.sd.dyn[,,is.pati], c(1,2), mean, na.rm=T)
thetas.sd.dyn.ctrl = apply(thetas.sd.dyn[,,is.ctrl], c(1,2), mean, na.rm=T)
```

### Statistics on connectivity strengths
```{r}
stats.theta.mean = ttest.nettest(thetas.mean, mydata$group, alpha = 0.05)
stats.theta.sd   = ttest.nettest(thetas.sd, mydata$group, alpha = 0.05)

stats.theta.mean.dyn = ttest.nettest(thetas.mean.dyn, mydata$group, alpha = 0.05)
stats.theta.sd.dyn   = ttest.nettest(thetas.sd.dyn, mydata$group, alpha = 0.05)
```

### Plot theta mean
```{r fig.height=5, fig.width=9, message=FALSE, warning=FALSE}
lim = max(abs(c(thetas.mean.ctrl, thetas.mean.pati)), na.rm = T)

p1 = gplotMat(thetas.mean.pati, title = "Patients", barWidth = 0.3,
              gradient = c("blue", "white", "red"), lim = c(-lim, lim),
              nodeLabels = mylabels, xAngle = 90, axisTextSize = 8) +
  scale_x_continuous(breaks = 0.5:br, labels = mylabels)

lim = max(abs(stats.theta.mean$t), na.rm = T)

p2 = gplotMat(stats.theta.mean$t_uncorr, title = "t-test (uc.)", barWidth = 0.3, 
              gradient = c("blue", "white", "red"), lim = c(-lim, lim),
              nodeLabels = mylabels, xAngle = 90, axisTextSize = 8) +
  scale_x_continuous(breaks = 0.5:br, labels = mylabels)

p3 = gplotMat(stats.theta.mean$t_fdr, title = "t-test (fdr)", barWidth = 0.3, 
              gradient = c("blue", "white", "red"), lim = c(-lim, lim),
              nodeLabels = mylabels, xAngle = 90, axisTextSize = 8) +
  scale_x_continuous(breaks = 0.5:br, labels = mylabels)

lim = max(abs(c(thetas.mean.ctrl, thetas.mean.pati)), na.rm = T)

p4 = gplotMat(thetas.mean.ctrl, title = "Controls", barWidth = 0.3,
              gradient = c("blue", "white", "red"), lim = c(-lim, lim),
              nodeLabels = mylabels, xAngle = 90, axisTextSize = 8) +
  scale_x_continuous(breaks = 0.5:br, labels = mylabels)


# sign. test on dynamic data only

lim = max(abs(stats.theta.mean.dyn$t), na.rm = T)

p5 = gplotMat(stats.theta.mean.dyn$t_uncorr, title = "t-test (uc.)", barWidth = 0.3, 
              gradient = c("blue", "white", "red"), lim = c(-lim, lim),
              nodeLabels = mylabels, xAngle = 90, axisTextSize = 8) +
  scale_x_continuous(breaks = 0.5:br, labels = mylabels)

p6 = gplotMat(stats.theta.mean.dyn$t_fdr, title = "t-test (fdr)", barWidth = 0.3, 
              gradient = c("blue", "white", "red"), lim = c(-lim, lim),
              nodeLabels = mylabels, xAngle = 90, axisTextSize = 8) +
  scale_x_continuous(breaks = 0.5:br, labels = mylabels)

plot_grid(p1, p2, p3, p4, p5, p6, ncol = 3, nrow = 2)
ggsave(path = PATH_FIGS, sprintf('DGM_%s-thetas-mean.png', INFO))
```


### Plot theta SD
```{r fig.height=5, fig.width=9, message=FALSE, warning=FALSE}
lim = max(abs(c(thetas.sd.ctrl, thetas.sd.pati)), na.rm = T)

p1 = gplotMat(thetas.sd.pati, title = "Patients", barWidth = 0.3, lim = c(0, lim),
              nodeLabels = mylabels, xAngle = 90, axisTextSize = 8) +
  scale_x_continuous(breaks = 0.5:br, labels = mylabels)

lim = max(abs(stats.theta.mean$t), na.rm = T)

p2 = gplotMat(stats.theta.sd$t_uncorr, title = "t-test (uc.)", barWidth = 0.3, 
              gradient = c("blue", "white", "red"), lim = c(-lim, lim),
              nodeLabels = mylabels, xAngle = 90, axisTextSize = 8) +
  scale_x_continuous(breaks = 0.5:br, labels = mylabels)

p3 = gplotMat(stats.theta.sd$t_fdr, title = "t-test (fdr)", barWidth = 0.3, 
              gradient = c("blue", "white", "red"), lim = c(-lim, lim),
              nodeLabels = mylabels, xAngle = 90, axisTextSize = 8) +
  scale_x_continuous(breaks = 0.5:br, labels = mylabels)

lim = max(abs(c(thetas.sd.ctrl, thetas.sd.pati)), na.rm = T)

p4 = gplotMat(thetas.sd.ctrl, title = "Controls", barWidth = 0.3, lim = c(0, lim),
              nodeLabels = mylabels, xAngle = 90, axisTextSize = 8) +
  scale_x_continuous(breaks = 0.5:br, labels = mylabels)

# sign. test on dynamic data only

lim = max(abs(stats.theta.sd.dyn$t), na.rm = T)

p5 = gplotMat(stats.theta.sd.dyn$t_uncorr, title = "t-test (uc.)", barWidth = 0.3, 
              gradient = c("blue", "white", "red"), lim = c(-lim, lim),
              nodeLabels = mylabels, xAngle = 90, axisTextSize = 8) +
  scale_x_continuous(breaks = 0.5:br, labels = mylabels)

p6 = gplotMat(stats.theta.sd.dyn$t_fdr, title = "t-test (fdr)", barWidth = 0.3, 
              gradient = c("blue", "white", "red"), lim = c(-lim, lim),
              nodeLabels = mylabels, xAngle = 90, axisTextSize = 8) +
  scale_x_continuous(breaks = 0.5:br, labels = mylabels)

plot_grid(p1, p2, p3, p4, p5, p6, ncol = 3, nrow = 2)
ggsave(path = PATH_FIGS, sprintf('DGM_%s-thetas-sd.png', INFO))
```

## Difference in discount factor
```{r}
tvals = rep(NA, Nn)
pvals = rep(NA, Nn)

g = as.factor(c(rep("control", sum(is.ctrl)), rep("patient", sum(is.pati))))

for (n in 1:Nn) {
  x = c(dgm.ctrl$df_[,n], dgm.pati$df_[,n])
  s = t.test(x ~ g, var.equal = T)
  tvals[n] = s$statistic
  pvals[n] = s$p.value
}

t=cbind(tvals, pvals)
rownames(t)=mylabels
print(t)
```

## Plot some theta_t from random subjects
```{r fig.height=10, fig.width=5}
n = 1 # node
s = 3# subjects

p=list()
c = 1
for (s in c(11:20)) {
  d = TH[[n]][,,s]
  colnames(d) = mylabels[AM.all_FDR[,n]==1]
  d_ = melt(d)
  d_$Var2=as.factor(d_$Var2)
  p[[c]] = ggplot(d_, aes(x = Var1, y = value, group=Var2, color=Var2)) + 
    geom_line() + theme_minimal() + ggtitle(sprintf('%s: %s', mydata$eid[s], mylabels[n])) +
    ylim(c(-1.5, 1.5))
  c = c + 1
}

plot_grid(plotlist = p, ncol = 2, nrow = 5, rel_widths = c(1, 1))
```

